<!DOCTYPE html>
<html lang="zh-TW">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>ğŸ„ è–èª•äº¤æ›ç¦®ç‰©æŠ½ç ğŸ</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            :root {
                --christmas-red: #c41e3a;
                --christmas-green: #165b33;
                --christmas-gold: #f8b229;
                --christmas-white: #f5f5f5;
                --christmas-black: #1a1a1a;
                --dark-green: #0d3320;
            }

            body {
                font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
                background: linear-gradient(135deg, var(--dark-green) 0%, var(--christmas-black) 100%);
                min-height: 100vh;
                overflow: hidden;
            }

            /* ä¸»å®¹å™¨ - 1920x1080 */
            .main-container {
                width: 1920px;
                height: 1080px;
                margin: 0 auto;
                position: relative;
                overflow: hidden;
            }

            /* é›ªèŠ±èƒŒæ™¯ */
            .snowflakes {
                position: absolute;
                width: 100%;
                height: 100%;
                pointer-events: none;
                z-index: 1;
            }

            .snowflake {
                position: absolute;
                color: rgba(255, 255, 255, 0.6);
                font-size: 1.5em;
                animation: fall linear infinite;
            }

            @keyframes fall {
                0% {
                    transform: translateY(-10%) rotate(0deg);
                    opacity: 1;
                }
                100% {
                    transform: translateY(110vh) rotate(360deg);
                    opacity: 0.3;
                }
            }

            /* æ¨™é¡Œå€ */
            .header {
                text-align: center;
                padding: 30px 0;
                position: relative;
                z-index: 10;
            }

            .header h1 {
                font-size: 72px;
                color: var(--christmas-white);
                text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.5), 0 0 30px var(--christmas-gold);
                letter-spacing: 8px;
            }

            .header .subtitle {
                font-size: 28px;
                color: var(--christmas-gold);
                margin-top: 10px;
            }

            /* ä¸»è¦å…§å®¹å€ */
            .content {
                display: flex;
                height: calc(100% - 180px);
                padding: 0 40px;
                gap: 40px;
                position: relative;
                z-index: 10;
            }

            /* çƒæ± å€åŸŸ */
            .pool-section {
                flex: 1;
                background: rgba(255, 255, 255, 0.05);
                border-radius: 30px;
                border: 3px solid var(--christmas-green);
                padding: 30px;
                position: relative;
                overflow: hidden;
            }

            .pool-title {
                font-size: 32px;
                color: var(--christmas-white);
                text-align: center;
                margin-bottom: 20px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 15px;
            }

            .pool-count {
                background: var(--christmas-red);
                padding: 5px 20px;
                border-radius: 20px;
                font-size: 24px;
            }

            .ball-pool {
                display: flex;
                flex-wrap: wrap;
                gap: 20px;
                justify-content: center;
                align-content: flex-start;
                height: calc(100% - 70px);
                overflow-y: auto;
                padding: 10px;
            }

            .ball {
                width: 120px;
                height: 150px;
                display: flex;
                flex-direction: column;
                align-items: center;
                animation: float 3s ease-in-out infinite;
                transition: all 0.3s ease;
            }

            .ball:nth-child(odd) {
                animation-delay: -1.5s;
            }

            .ball.new-join {
                animation: popIn 0.5s ease-out;
            }

            @keyframes popIn {
                0% {
                    transform: scale(0);
                    opacity: 0;
                }
                50% {
                    transform: scale(1.2);
                }
                100% {
                    transform: scale(1);
                    opacity: 1;
                }
            }

            @keyframes float {
                0%,
                100% {
                    transform: translateY(0);
                }
                50% {
                    transform: translateY(-10px);
                }
            }

            .ball-avatar {
                width: 100px;
                height: 100px;
                border-radius: 50%;
                border: 4px solid var(--christmas-gold);
                overflow: hidden;
                background: var(--christmas-green);
                box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
            }

            .ball-avatar img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

            .ball-avatar .placeholder {
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 40px;
                color: var(--christmas-white);
                background: linear-gradient(135deg, var(--christmas-red), var(--christmas-green));
            }

            .ball-name {
                margin-top: 10px;
                font-size: 18px;
                color: var(--christmas-white);
                text-align: center;
                max-width: 120px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            /* æŠ½çå€åŸŸ */
            .lottery-section {
                width: 600px;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 30px;
            }

            /* ç•¶å‰æŠ½çè€… */
            .current-drawer {
                background: rgba(255, 255, 255, 0.1);
                border-radius: 20px;
                padding: 25px;
                text-align: center;
                width: 100%;
                border: 2px solid var(--christmas-gold);
            }

            .current-drawer-label {
                font-size: 24px;
                color: var(--christmas-gold);
                margin-bottom: 15px;
            }

            .current-drawer-info {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 20px;
            }

            .current-drawer-avatar {
                width: 80px;
                height: 80px;
                border-radius: 50%;
                border: 3px solid var(--christmas-white);
                overflow: hidden;
                background: var(--christmas-green);
            }

            .current-drawer-avatar img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

            .current-drawer-name {
                font-size: 36px;
                color: var(--christmas-white);
            }

            /* æŠ½çå‹•ç•«å€ */
            .lottery-display {
                width: 100%;
                height: 350px;
                background: radial-gradient(ellipse at center, rgba(196, 30, 58, 0.3) 0%, transparent 70%);
                border-radius: 30px;
                border: 3px solid var(--christmas-red);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                position: relative;
                overflow: hidden;
            }

            .lottery-display::before {
                content: '';
                position: absolute;
                top: -50%;
                left: -50%;
                width: 200%;
                height: 200%;
                background: conic-gradient(from 0deg, transparent, var(--christmas-gold), transparent);
                animation: rotate 4s linear infinite;
                opacity: 0.1;
            }

            @keyframes rotate {
                100% {
                    transform: rotate(360deg);
                }
            }

            .lottery-avatar {
                width: 180px;
                height: 180px;
                border-radius: 50%;
                border: 6px solid var(--christmas-gold);
                overflow: hidden;
                background: var(--christmas-green);
                box-shadow: 0 0 50px rgba(248, 178, 41, 0.5);
                position: relative;
                z-index: 2;
            }

            .lottery-avatar img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

            .lottery-avatar .placeholder {
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 60px;
                color: var(--christmas-white);
            }

            .lottery-name {
                font-size: 48px;
                color: var(--christmas-white);
                margin-top: 20px;
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
                position: relative;
                z-index: 2;
            }

            .lottery-status {
                font-size: 28px;
                color: var(--christmas-gold);
                position: relative;
                z-index: 2;
            }

            /* æŠ½çæŒ‰éˆ• */
            .lottery-btn {
                width: 280px;
                height: 80px;
                font-size: 32px;
                font-weight: bold;
                color: var(--christmas-white);
                background: linear-gradient(135deg, var(--christmas-red) 0%, #8b0000 100%);
                border: none;
                border-radius: 40px;
                cursor: pointer;
                box-shadow: 0 8px 25px rgba(196, 30, 58, 0.5);
                transition: all 0.3s ease;
                position: relative;
                overflow: hidden;
            }

            .lottery-btn:hover:not(:disabled) {
                transform: translateY(-3px);
                box-shadow: 0 12px 35px rgba(196, 30, 58, 0.7);
            }

            .lottery-btn:active:not(:disabled) {
                transform: translateY(0);
            }

            .lottery-btn:disabled {
                opacity: 0.6;
                cursor: not-allowed;
            }

            .lottery-btn::before {
                content: '';
                position: absolute;
                top: -50%;
                left: -50%;
                width: 200%;
                height: 200%;
                background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.2), transparent);
                transform: rotate(45deg);
                animation: shine 3s infinite;
            }

            @keyframes shine {
                0% {
                    left: -50%;
                }
                100% {
                    left: 150%;
                }
            }

            /* æŠ½çä¸­å‹•ç•« */
            .rolling .lottery-avatar {
                animation: shake 0.1s infinite;
            }

            .rolling .lottery-name {
                animation: blink 0.15s infinite;
            }

            @keyframes shake {
                0%,
                100% {
                    transform: translateX(0);
                }
                25% {
                    transform: translateX(-5px);
                }
                75% {
                    transform: translateX(5px);
                }
            }

            @keyframes blink {
                0%,
                100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.5;
                }
            }

            /* ä¸­çæ•ˆæœ */
            .winner .lottery-display {
                animation: celebrate 0.5s ease-out;
                border-color: var(--christmas-gold);
                box-shadow: 0 0 60px rgba(248, 178, 41, 0.6);
            }

            @keyframes celebrate {
                0%,
                100% {
                    transform: scale(1);
                }
                50% {
                    transform: scale(1.02);
                }
            }

            .winner .lottery-avatar {
                animation: bounce 0.6s ease;
            }

            @keyframes bounce {
                0%,
                100% {
                    transform: scale(1);
                }
                50% {
                    transform: scale(1.1);
                }
            }

            /* æ§åˆ¶é¢æ¿ */
            .control-panel {
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(0, 0, 0, 0.9);
                border-radius: 15px;
                z-index: 1000;
                border: 2px solid var(--christmas-green);
                max-width: 280px;
                transition: all 0.3s ease;
            }

            .control-panel.collapsed {
                max-width: 60px;
                border-radius: 30px;
            }

            .control-panel-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                cursor: pointer;
                user-select: none;
            }

            .control-panel-header h3 {
                color: var(--christmas-gold);
                font-size: 18px;
                margin: 0;
                white-space: nowrap;
                overflow: hidden;
                transition: opacity 0.3s;
            }

            .control-panel.collapsed .control-panel-header h3 {
                opacity: 0;
                width: 0;
            }

            .toggle-btn {
                background: var(--christmas-green);
                border: none;
                color: white;
                width: 30px;
                height: 30px;
                border-radius: 50%;
                cursor: pointer;
                font-size: 16px;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: transform 0.3s;
                flex-shrink: 0;
            }

            .toggle-btn:hover {
                background: #1e7a46;
            }

            .control-panel.collapsed .toggle-btn {
                transform: rotate(180deg);
            }

            .control-panel-content {
                padding: 0 20px 20px;
                overflow: hidden;
                transition: all 0.3s ease;
            }

            .control-panel.collapsed .control-panel-content {
                height: 0;
                padding: 0;
                opacity: 0;
            }

            .control-panel .status {
                color: var(--christmas-white);
                font-size: 14px;
                margin: 15px 0;
                padding: 10px;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 8px;
            }

            .control-panel .status.connected {
                border-left: 3px solid #4caf50;
            }

            .control-panel .status.disconnected {
                border-left: 3px solid var(--christmas-red);
            }

            .control-panel button {
                display: block;
                width: 100%;
                background: var(--christmas-green);
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
                transition: background 0.3s;
            }

            .control-panel button:hover {
                background: #1e7a46;
            }

            .control-panel .reset-btn {
                background: var(--christmas-red);
            }

            .control-panel .reset-btn:hover {
                background: #a01830;
            }

            .control-panel .clear-all-btn {
                background: #333;
                border: 1px solid #666;
                margin-top: 5px;
            }

            .control-panel .clear-all-btn:hover {
                background: #444;
            }

            .control-panel hr {
                border: none;
                border-top: 1px solid rgba(255, 255, 255, 0.2);
                margin: 15px 0;
            }

            .participant-select {
                width: 100%;
                padding: 10px;
                margin: 10px 0;
                border-radius: 8px;
                border: none;
                font-size: 14px;
            }

            /* å®Œæˆç•«é¢ */
            .complete-overlay {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.9);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                z-index: 100;
                opacity: 0;
                visibility: hidden;
                transition: all 0.5s ease;
            }

            .complete-overlay.show {
                opacity: 1;
                visibility: visible;
            }

            .complete-overlay h2 {
                font-size: 72px;
                color: var(--christmas-gold);
                text-shadow: 0 0 30px var(--christmas-gold);
                margin-bottom: 30px;
            }

            .complete-overlay p {
                font-size: 36px;
                color: var(--christmas-white);
            }

            /* QR Code é¡¯ç¤ºå€ */
            .qr-section {
                position: absolute;
                bottom: 30px;
                left: 40px;
                text-align: center;
                z-index: 10;
                background: rgba(0, 0, 0, 0.6);
                padding: 20px;
                border-radius: 15px;
            }

            .qr-code {
                width: 150px;
                height: 150px;
                background: white;
                border-radius: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 0 auto 10px;
                padding: 10px;
            }

            .qr-code img {
                max-width: 100%;
                max-height: 100%;
            }

            .qr-code canvas {
                max-width: 100%;
                max-height: 100%;
            }

            .qr-section p {
                color: var(--christmas-white);
                font-size: 16px;
            }

            .qr-section .url {
                color: var(--christmas-gold);
                font-size: 12px;
                margin-top: 5px;
                word-break: break-all;
                max-width: 150px;
            }

            /* æ­·å²è¨˜éŒ„ */
            .history-section {
                position: absolute;
                bottom: 20px;
                right: 20px;
                background: rgba(0, 0, 0, 0.6);
                padding: 15px;
                border-radius: 15px;
                max-height: 200px;
                overflow-y: auto;
                z-index: 10;
            }

            .history-section h4 {
                color: var(--christmas-gold);
                margin-bottom: 10px;
                font-size: 16px;
            }

            .history-item {
                color: var(--christmas-white);
                font-size: 14px;
                margin: 5px 0;
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .history-item .arrow {
                color: var(--christmas-red);
            }

            /* ç­‰å¾…åŠ å…¥ç•«é¢ */
            .waiting-message {
                text-align: center;
                padding: 100px;
            }

            .waiting-message h2 {
                font-size: 48px;
                color: var(--christmas-white);
                margin-bottom: 20px;
            }

            .waiting-message p {
                font-size: 28px;
                color: var(--christmas-gold);
            }

            /* æ»¾å‹•æ¢æ¨£å¼ */
            ::-webkit-scrollbar {
                width: 8px;
            }

            ::-webkit-scrollbar-track {
                background: rgba(255, 255, 255, 0.1);
                border-radius: 4px;
            }

            ::-webkit-scrollbar-thumb {
                background: var(--christmas-green);
                border-radius: 4px;
            }
        </style>
    </head>
    <body>
        <div class="main-container" id="app">
            <!-- é›ªèŠ±èƒŒæ™¯ -->
            <div class="snowflakes" id="snowflakes"></div>

            <!-- æ¨™é¡Œ -->
            <header class="header">
                <h1>ğŸ„ è–èª•äº¤æ›ç¦®ç‰© ğŸ</h1>
                <p class="subtitle">Merry Christmas & Happy New Year</p>
            </header>

            <!-- ä¸»è¦å…§å®¹ -->
            <div class="content">
                <!-- çƒæ± å€åŸŸ -->
                <div class="pool-section">
                    <div class="pool-title">
                        ğŸ± æŠ½ççƒæ± 
                        <span class="pool-count">å‰©é¤˜ <span id="poolCount">0</span> äºº</span>
                    </div>
                    <div class="ball-pool" id="ballPool">
                        <div class="waiting-message">
                            <h2>ç­‰å¾…åƒåŠ è€…åŠ å…¥...</h2>
                            <p>è«‹æƒæå·¦ä¸‹è§’ QR Code åŠ å…¥æŠ½ç</p>
                        </div>
                    </div>
                </div>

                <!-- æŠ½çå€åŸŸ -->
                <div class="lottery-section">
                    <!-- ç•¶å‰æŠ½çè€… -->
                    <div class="current-drawer" id="currentDrawer">
                        <div class="current-drawer-label">ğŸ… ç›®å‰æŠ½çè€…</div>
                        <div class="current-drawer-info">
                            <div class="current-drawer-avatar" id="drawerAvatar">
                                <div class="placeholder">?</div>
                            </div>
                            <div class="current-drawer-name" id="drawerName">ç­‰å¾…ä¸»æŒäººæŒ‡å®š</div>
                        </div>
                    </div>

                    <!-- æŠ½çå±•ç¤ºå€ -->
                    <div class="lottery-display" id="lotteryDisplay">
                        <div class="lottery-avatar" id="lotteryAvatar">
                            <div class="placeholder">ğŸ</div>
                        </div>
                        <div class="lottery-name" id="lotteryName">æº–å‚™æŠ½ç</div>
                        <div class="lottery-status" id="lotteryStatus"></div>
                    </div>

                    <!-- æŠ½çæŒ‰éˆ• -->
                    <button class="lottery-btn" id="lotteryBtn" disabled>ğŸ° é–‹å§‹æŠ½ç</button>
                </div>
            </div>

            <!-- QR Code å€åŸŸ -->
            <div class="qr-section" id="qrSection">
                <div class="qr-code" id="qrCode">
                    <span style="color: #666; font-size: 12px">è¼‰å…¥ä¸­...</span>
                </div>
                <p>ğŸ“± æƒæåŠ å…¥æŠ½ç</p>
                <p class="url" id="joinUrl"></p>
            </div>

            <!-- æ­·å²è¨˜éŒ„ -->
            <div class="history-section" id="historySection" style="display: none">
                <h4>ğŸ“œ æŠ½çè¨˜éŒ„</h4>
                <div id="historyList"></div>
            </div>

            <!-- å®Œæˆç•«é¢ -->
            <div class="complete-overlay" id="completeOverlay">
                <h2>ğŸ‰ æŠ½çå®Œæˆï¼ğŸ‰</h2>
                <p>ç¥å¤§å®¶è–èª•å¿«æ¨‚ï¼</p>
            </div>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="control-panel" id="controlPanel">
            <div class="control-panel-header" onclick="toggleControlPanel()">
                <h3>ğŸ› ï¸ ä¸»æŒäººæ§åˆ¶å°</h3>
                <button class="toggle-btn" title="æ”¶åˆ/å±•é–‹">-</button>
            </div>
            <div class="control-panel-content">
                <div class="status" id="firebaseStatus">â³ é€£ç·šä¸­...</div>

                <label style="color: white; font-size: 14px">æŒ‡å®šç¬¬ä¸€ä½æŠ½çè€…ï¼š</label>
                <select class="participant-select" id="firstDrawerSelect">
                    <option value="">-- è«‹é¸æ“‡ --</option>
                </select>
                <button onclick="setFirstDrawer()">ç¢ºèªæŒ‡å®š</button>

                <hr />

                <button class="reset-btn" onclick="resetGame()">ğŸ”„ é‡ç½®éŠæˆ²</button>
                <button class="clear-all-btn" onclick="clearAllData()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
            </div>
        </div>

        <!-- Firebase SDK -->
        <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

        <!-- QR Code ç”Ÿæˆå™¨ -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

        <script>
            // ==================== ğŸ¯ æš—æ¨è¨­å®šå€ ====================
            // è§¸ç™¼æš—æ¨çš„æŠ½çè€…åå–®ï¼ˆåå­—åŒ…å«é€™äº›æ–‡å­—å°±æœƒè§¸ç™¼ï¼‰
            const RIGGED_DRAWER_NAMES = ['æ¦›', 'æ£’', 'Diane', 'æé¾']

            // æš—æ¨æŒ‡å®šä¸­çè€…çš„åå­—ï¼ˆå¿…é ˆå®Œå…¨ç¬¦åˆï¼‰
            const RIGGED_WINNER_NAME = 'é¥…é ­' // ä¾‹å¦‚ï¼š'å°ç¾'

            // ==================== Firebase è¨­å®š ====================
            // è«‹å°‡ä¸‹æ–¹çš„è¨­å®šæ›¿æ›æˆä½ è‡ªå·±çš„ Firebase å°ˆæ¡ˆè¨­å®š
            const firebaseConfig = {
                apiKey: 'AIzaSyCao44vYtNN_LJDFWe1FfssDT9H2e2DZEs',
                authDomain: 'gift-exchange-ff3d4.firebaseapp.com',
                databaseURL: 'https://gift-exchange-ff3d4-default-rtdb.asia-southeast1.firebasedatabase.app',
                projectId: 'gift-exchange-ff3d4',
                storageBucket: 'gift-exchange-ff3d4.firebasestorage.app',
                messagingSenderId: '435810354824',
                appId: '1:435810354824:web:879aded64a1a01a733813d',
                measurementId: 'G-V6CW8BFWV6',
            }

            // åˆå§‹åŒ– Firebase
            firebase.initializeApp(firebaseConfig)
            const database = firebase.database()

            // ==================== éŠæˆ²ç‹€æ…‹ ====================
            let gameState = {
                participants: [],
                pool: [],
                currentDrawer: null,
                history: [],
                drawnIds: [],
                isRolling: false,
                isComplete: false,
            }

            // ==================== åˆå§‹åŒ– ====================
            function init() {
                createSnowflakes()
                generateQRCode()
                listenToParticipants()
                listenToGameState()

                // ç›£è½ Firebase é€£ç·šç‹€æ…‹
                database.ref('.info/connected').on('value', (snap) => {
                    const statusEl = document.getElementById('firebaseStatus')
                    if (snap.val() === true) {
                        statusEl.textContent = 'âœ… Firebase å·²é€£ç·š'
                        statusEl.className = 'status connected'
                    } else {
                        statusEl.textContent = 'âŒ Firebase å·²æ–·ç·š'
                        statusEl.className = 'status disconnected'
                    }
                })
            }

            // ==================== QR Code ====================
            function generateQRCode() {
                const currentUrl = window.location.href
                const joinUrl = currentUrl.replace(/index\.html.*$/, 'join.html').replace(/\/$/, '/join.html')

                document.getElementById('joinUrl').textContent =
                    joinUrl.length > 30 ? joinUrl.substring(0, 30) + '...' : joinUrl

                const qrContainer = document.getElementById('qrCode')
                qrContainer.innerHTML = '' // æ¸…ç©ºå®¹å™¨

                try {
                    new QRCode(qrContainer, {
                        text: joinUrl,
                        width: 130,
                        height: 130,
                        colorDark: '#165b33',
                        colorLight: '#ffffff',
                        correctLevel: QRCode.CorrectLevel.M,
                    })
                } catch (error) {
                    console.error('QR Code ç”Ÿæˆå¤±æ•—:', error)
                    qrContainer.innerHTML = '<span style="color: #666; font-size: 10px;">QR ç”Ÿæˆå¤±æ•—</span>'
                }
            }

            // ==================== Firebase ç›£è½ ====================
            function listenToParticipants() {
                database.ref('participants').on('value', (snapshot) => {
                    const data = snapshot.val()
                    if (data) {
                        const newParticipants = Object.values(data)
                        const existingIds = gameState.participants.map((p) => p.id)
                        const newJoins = newParticipants.filter((p) => !existingIds.includes(p.id))

                        gameState.participants = newParticipants
                        updatePoolFromParticipants()
                        renderPool(newJoins.map((p) => p.id))
                        updatePoolCount()
                        updateFirstDrawerSelect()
                    } else {
                        gameState.participants = []
                        gameState.pool = []
                        renderPool([])
                        updatePoolCount()
                        updateFirstDrawerSelect()
                    }
                })
            }

            function listenToGameState() {
                database.ref('gameState').on('value', (snapshot) => {
                    const data = snapshot.val()
                    if (data) {
                        if (data.currentDrawer) {
                            gameState.currentDrawer = data.currentDrawer
                            updateCurrentDrawer()
                            document.getElementById('lotteryBtn').disabled = false
                        }
                        if (data.drawnIds) {
                            gameState.drawnIds = data.drawnIds
                            updatePoolFromParticipants()
                            renderPool([])
                            updatePoolCount()
                        }
                        if (data.history) {
                            gameState.history = data.history
                            updateHistory()
                        }
                    }
                })
            }

            function updatePoolFromParticipants() {
                const drawnIds = gameState.drawnIds || []
                gameState.pool = gameState.participants.filter((p) => !drawnIds.includes(p.id))
            }

            // ==================== æ¸²æŸ“çƒæ±  ====================
            function renderPool(newJoinIds = []) {
                const poolEl = document.getElementById('ballPool')

                if (gameState.pool.length === 0 && gameState.participants.length === 0) {
                    poolEl.innerHTML = `
                    <div class="waiting-message">
                        <h2>ç­‰å¾…åƒåŠ è€…åŠ å…¥...</h2>
                        <p>è«‹æƒæå·¦ä¸‹è§’ QR Code åŠ å…¥æŠ½ç</p>
                    </div>
                `
                    return
                }

                if (gameState.pool.length === 0) {
                    poolEl.innerHTML = `
                    <div class="waiting-message">
                        <h2>çƒæ± å·²æ¸…ç©º</h2>
                        <p>æŠ½çå®Œæˆï¼</p>
                    </div>
                `
                    return
                }

                poolEl.innerHTML = gameState.pool
                    .map(
                        (p) => `
                <div class="ball ${newJoinIds.includes(p.id) ? 'new-join' : ''}" data-id="${p.id}">
                    <div class="ball-avatar">
                        <img src="${p.avatar}" alt="${
                            p.name
                        }" onerror="this.parentElement.innerHTML='<div class=\\'placeholder\\'>${p.name.charAt(
                            0
                        )}</div>'">
                    </div>
                    <div class="ball-name">${p.name}</div>
                </div>
            `
                    )
                    .join('')
            }

            function updatePoolCount() {
                document.getElementById('poolCount').textContent = gameState.pool.length
            }

            function updateFirstDrawerSelect() {
                const select = document.getElementById('firstDrawerSelect')
                const currentValue = select.value

                select.innerHTML = '<option value="">-- è«‹é¸æ“‡ --</option>'
                gameState.participants.forEach((p) => {
                    const option = document.createElement('option')
                    option.value = p.id
                    option.textContent = p.name
                    select.appendChild(option)
                })

                select.value = currentValue
            }

            // ==================== æŒ‡å®šç¬¬ä¸€ä½æŠ½çè€… ====================
            function setFirstDrawer() {
                const select = document.getElementById('firstDrawerSelect')
                const selectedId = select.value

                if (!selectedId) {
                    alert('è«‹é¸æ“‡ä¸€ä½åƒåŠ è€…ï¼')
                    return
                }

                const firstDrawer = gameState.participants.find((p) => p.id === selectedId)
                if (!firstDrawer) return

                database.ref('gameState').update({
                    currentDrawer: firstDrawer,
                    drawnIds: [firstDrawer.id],
                })

                gameState.currentDrawer = firstDrawer
                gameState.drawnIds = [firstDrawer.id]

                updateCurrentDrawer()
                updatePoolFromParticipants()
                renderPool([])
                updatePoolCount()

                document.getElementById('lotteryBtn').disabled = false
            }

            function updateCurrentDrawer() {
                const drawer = gameState.currentDrawer
                const avatarEl = document.getElementById('drawerAvatar')
                const nameEl = document.getElementById('drawerName')

                if (drawer) {
                    avatarEl.innerHTML = `<img src="${drawer.avatar}" alt="${
                        drawer.name
                    }" onerror="this.parentElement.innerHTML='<div class=\\'placeholder\\'>${drawer.name.charAt(
                        0
                    )}</div>'">`
                    nameEl.textContent = drawer.name
                } else {
                    avatarEl.innerHTML = '<div class="placeholder">?</div>'
                    nameEl.textContent = 'ç­‰å¾…ä¸»æŒäººæŒ‡å®š'
                }
            }

            // ==================== æŠ½çå‹•ç•« ====================
            async function startLottery() {
                if (gameState.isRolling || gameState.pool.length === 0) return

                gameState.isRolling = true
                const btn = document.getElementById('lotteryBtn')
                btn.disabled = true
                btn.textContent = 'ğŸ° æŠ½çä¸­...'

                const display = document.getElementById('lotteryDisplay')
                const avatarEl = document.getElementById('lotteryAvatar')
                const nameEl = document.getElementById('lotteryName')
                const statusEl = document.getElementById('lotteryStatus')

                display.classList.add('rolling')
                display.classList.remove('winner')
                statusEl.textContent = ''

                // ğŸ¯ æš—æ¨é‚è¼¯ï¼šæª¢æŸ¥ç•¶å‰æŠ½çè€…æ˜¯å¦åœ¨æš—æ¨åå–®ä¸­
                let winner
                const currentDrawerName = gameState.currentDrawer?.name || ''
                const isRigged = RIGGED_DRAWER_NAMES.some((name) => currentDrawerName.includes(name))

                if (isRigged && RIGGED_WINNER_NAME) {
                    // å°‹æ‰¾æŒ‡å®šçš„ä¸­çè€…
                    const riggedWinner = gameState.pool.find((p) => p.name === RIGGED_WINNER_NAME)
                    if (riggedWinner) {
                        winner = riggedWinner
                        console.log('ğŸ¯ æš—æ¨è§¸ç™¼ï¼š', currentDrawerName, 'â†’', RIGGED_WINNER_NAME)
                    } else {
                        // æŒ‡å®šçš„äººä¸åœ¨çƒæ± ä¸­ï¼Œæ”¹ç‚ºéš¨æ©Ÿ
                        const winnerIndex = Math.floor(Math.random() * gameState.pool.length)
                        winner = gameState.pool[winnerIndex]
                        console.log('âš ï¸ æš—æ¨ç›®æ¨™ä¸åœ¨çƒæ± ä¸­ï¼Œæ”¹ç‚ºéš¨æ©Ÿ')
                    }
                } else {
                    // æ­£å¸¸éš¨æ©ŸæŠ½ç
                    const winnerIndex = Math.floor(Math.random() * gameState.pool.length)
                    winner = gameState.pool[winnerIndex]
                }

                // 3ç§’å‹•ç•«
                const duration = 3000
                const startTime = Date.now()

                const animate = () => {
                    const elapsed = Date.now() - startTime

                    if (elapsed < duration) {
                        const randomPerson = gameState.pool[Math.floor(Math.random() * gameState.pool.length)]
                        avatarEl.innerHTML = `<img src="${randomPerson.avatar}" alt="${randomPerson.name}">`
                        nameEl.textContent = randomPerson.name

                        const speed = Math.min(50 + (elapsed / duration) * 150, 200)
                        setTimeout(animate, speed)
                    } else {
                        showWinner(winner)
                    }
                }

                animate()
            }

            function showWinner(winner) {
                const display = document.getElementById('lotteryDisplay')
                const avatarEl = document.getElementById('lotteryAvatar')
                const nameEl = document.getElementById('lotteryName')
                const statusEl = document.getElementById('lotteryStatus')
                const btn = document.getElementById('lotteryBtn')

                display.classList.remove('rolling')
                display.classList.add('winner')

                avatarEl.innerHTML = `<img src="${winner.avatar}" alt="${winner.name}">`
                nameEl.textContent = winner.name
                statusEl.textContent = 'ğŸŠ æ­å–œä¸­çï¼ğŸŠ'

                const newHistory = [
                    ...(gameState.history || []),
                    {
                        drawer: gameState.currentDrawer,
                        winner: winner,
                    },
                ]

                const drawnIds = [...(gameState.drawnIds || []), winner.id]
                database.ref('gameState').update({
                    currentDrawer: winner,
                    drawnIds: drawnIds,
                    history: newHistory,
                })

                gameState.history = newHistory
                gameState.currentDrawer = winner
                gameState.drawnIds = drawnIds

                updateHistory()
                updateCurrentDrawer()
                updatePoolFromParticipants()
                renderPool([])
                updatePoolCount()

                gameState.isRolling = false

                if (gameState.pool.length === 0) {
                    setTimeout(() => {
                        gameState.isComplete = true
                        document.getElementById('completeOverlay').classList.add('show')
                    }, 2000)
                    btn.textContent = 'ğŸ‰ æŠ½çå®Œæˆ'
                    btn.disabled = true
                } else {
                    btn.textContent = 'ğŸ° é–‹å§‹æŠ½ç'
                    btn.disabled = false
                }
            }

            function updateHistory() {
                const historySection = document.getElementById('historySection')
                const historyList = document.getElementById('historyList')

                if (gameState.history && gameState.history.length > 0) {
                    historySection.style.display = 'block'
                    historyList.innerHTML = gameState.history
                        .map(
                            (h, i) => `
                    <div class="history-item">
                        <span>${i + 1}.</span>
                        <span>${h.drawer.name}</span>
                        <span class="arrow">â†’</span>
                        <span>${h.winner.name}</span>
                    </div>
                `
                        )
                        .join('')
                }
            }

            // ==================== æ§åˆ¶é¢æ¿æ”¶æŠ˜ ====================
            function toggleControlPanel() {
                const panel = document.getElementById('controlPanel')
                panel.classList.toggle('collapsed')
            }

            // ==================== æ¸…é™¤æ‰€æœ‰è³‡æ–™ ====================
            function clearAllData() {
                if (
                    !confirm(
                        'âš ï¸ ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿ\n\né€™å°‡æœƒåˆªé™¤ï¼š\nâ€¢ æ‰€æœ‰åƒåŠ è€…è³‡æ–™\nâ€¢ æ‰€æœ‰æŠ½çç´€éŒ„\nâ€¢ Storage ä¸­çš„ç…§ç‰‡\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼'
                    )
                )
                    return

                if (!confirm('ğŸš¨ å†æ¬¡ç¢ºèªï¼šçœŸçš„è¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿ')) return

                // æ¸…é™¤ Realtime Database
                database.ref('participants').remove()
                database.ref('gameState').remove()

                // æ¸…é™¤ Storage ä¸­çš„ç…§ç‰‡
                const storage = firebase.storage()
                const photosRef = storage.ref('photos')

                photosRef
                    .listAll()
                    .then((result) => {
                        const deletePromises = result.items.map((item) => item.delete())
                        return Promise.all(deletePromises)
                    })
                    .then(() => {
                        console.log('æ‰€æœ‰ç…§ç‰‡å·²åˆªé™¤')
                    })
                    .catch((error) => {
                        console.error('åˆªé™¤ç…§ç‰‡æ™‚ç™¼ç”ŸéŒ¯èª¤:', error)
                    })

                // é‡ç½®æœ¬åœ°ç‹€æ…‹
                gameState = {
                    participants: [],
                    pool: [],
                    currentDrawer: null,
                    history: [],
                    drawnIds: [],
                    isRolling: false,
                    isComplete: false,
                }

                // é‡ç½® UI
                document.getElementById('completeOverlay').classList.remove('show')
                document.getElementById('historySection').style.display = 'none'
                document.getElementById('historyList').innerHTML = ''
                document.getElementById('lotteryBtn').disabled = true
                document.getElementById('lotteryBtn').textContent = 'ğŸ° é–‹å§‹æŠ½ç'
                document.getElementById('lotteryDisplay').classList.remove('rolling', 'winner')
                document.getElementById('lotteryAvatar').innerHTML = '<div class="placeholder">ğŸ</div>'
                document.getElementById('lotteryName').textContent = 'æº–å‚™æŠ½ç'
                document.getElementById('lotteryStatus').textContent = ''
                document.getElementById('firstDrawerSelect').innerHTML = '<option value="">-- è«‹é¸æ“‡ --</option>'

                updateCurrentDrawer()
                renderPool([])
                updatePoolCount()

                alert('âœ… æ‰€æœ‰è³‡æ–™å·²æ¸…é™¤å®Œæˆï¼')
            }

            // ==================== é‡ç½®éŠæˆ² ====================
            function resetGame() {
                if (!confirm('ç¢ºå®šè¦é‡ç½®éŠæˆ²å—ï¼Ÿæ‰€æœ‰æŠ½çç´€éŒ„å°‡è¢«æ¸…é™¤ã€‚')) return

                database.ref('gameState').remove()

                gameState = {
                    participants: gameState.participants,
                    pool: [...gameState.participants],
                    currentDrawer: null,
                    history: [],
                    drawnIds: [],
                    isRolling: false,
                    isComplete: false,
                }

                document.getElementById('completeOverlay').classList.remove('show')
                document.getElementById('historySection').style.display = 'none'
                document.getElementById('historyList').innerHTML = ''
                document.getElementById('lotteryBtn').disabled = true
                document.getElementById('lotteryBtn').textContent = 'ğŸ° é–‹å§‹æŠ½ç'
                document.getElementById('lotteryDisplay').classList.remove('rolling', 'winner')
                document.getElementById('lotteryAvatar').innerHTML = '<div class="placeholder">ğŸ</div>'
                document.getElementById('lotteryName').textContent = 'æº–å‚™æŠ½ç'
                document.getElementById('lotteryStatus').textContent = ''

                updateCurrentDrawer()
                renderPool([])
                updatePoolCount()
            }

            // ==================== é›ªèŠ±æ•ˆæœ ====================
            function createSnowflakes() {
                const container = document.getElementById('snowflakes')
                const snowflakeChars = ['â„', 'â…', 'â†', 'âœ»', 'âœ¼']

                for (let i = 0; i < 50; i++) {
                    const snowflake = document.createElement('div')
                    snowflake.className = 'snowflake'
                    snowflake.innerHTML = snowflakeChars[Math.floor(Math.random() * snowflakeChars.length)]
                    snowflake.style.left = Math.random() * 100 + '%'
                    snowflake.style.animationDuration = Math.random() * 10 + 10 + 's'
                    snowflake.style.animationDelay = -(Math.random() * 20) + 's'
                    snowflake.style.fontSize = Math.random() * 1.5 + 0.5 + 'em'
                    container.appendChild(snowflake)
                }
            }

            // ==================== ç¶å®šäº‹ä»¶ ====================
            document.getElementById('lotteryBtn').addEventListener('click', startLottery)

            // åˆå§‹åŒ– - ç­‰å¾…é é¢å®Œå…¨è¼‰å…¥
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init)
            } else {
                init()
            }
        </script>
    </body>
</html>
